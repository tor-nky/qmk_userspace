このソースは eswaiさんの [naginata_v15](https://github.com/eswai/qmk_firmware/tree/master/users/naginata_v15) を元に作成しています。

次のようなバイナリを作成することができます。
* 現行のMS-IMEでも使用できる辞書登録式  
WindowsとMacでは日本語キーボード、英語キーボードどちらでも使えます。
* IME設定を駆使して好みに近づけた方式  
* BLE Micro Pro用(Bluetooth接続のiPhoneを含む)
# 薙刀式カナ配列キーマップ
薙刀式カナ配列による入力をQMKで実現します。薙刀式v15に準拠しています。
編集モードも実装していますが、
編集モードでの記号入力方式がOSによって異なるので、
使用するOS(Windows、MacOS、Linux)によって切り替える必要があります。
切り替えは再コンパイル不要で、動的に切り替えられます。
## 薙刀式とは
【薙刀式】v15fix版、発表
http://oookaworks.seesaa.net/article/500180437.html#gsc.tab=0
## QMK Firmware　への組み込み方
1. [qmk_userspace/users/naginata_v15m/](https://github.com/tor-nky/qmk_userspace/tree/main/users/naginata_v15m) フォルダの内容を、各自の同様のフォルダを作りコピーする。
1. 各自の qmk_****/keyboards/%キーボード名%/keymaps/naginata_v15m/ フォルダに keymap.c を作成する。
1. こちらの [keymap.c](https://github.com/tor-nky/qmk_userspace/blob/main/keyboards/tor_nky/coconut42/keymaps/naginata_v15m/keymap.c) などを参考に、2つの `// 薙刀式` で囲まれた部分を付け加える。  
OLED を使わなければ7番目は不要です。
1. コンパイルする `qmk compile -kb %キーボード名% -km naginata_v15m`
1. キーボードに書き込む
## OSなどの設定 (辞書使用の場合とBLE Micro Pro)
IMEへの辞書登録が必要ですが、他の設定はいりません。そのため、現行のMS-IMEでも使えます。  
辞書使用の場合、config.h の中に ``#define NG_USE_DIC`` を書き加えてコンパイルします。

BLE Micro Pro の場合、vial-qmk/keyboards/ble_micro_pro/keymaps/ 下の [naginata_v15m/](https://github.com/tor-nky/vial-qmk/tree/kana/naginata/keyboards/ble_micro_pro/keymaps/naginata_v15m) と [vial/](https://github.com/tor-nky/vial-qmk/tree/kana/naginata/keyboards/ble_micro_pro/keymaps/vial) の内容の違いをお調べ下さい。
### 共通
下表のものを __辞書登録__ してください。
|単語|読み|参考|
|---|---|---|
|……|なぎてて|__なぎ__ なたしき __て__ ん __て__ ん|
|――|なぎよせ|__なぎ__ なたしき __よ__ こ __せ__ ん|
|（）|なぎまか|__なぎ__ なたしき __ま__ る __か__ っこ|
|「」|なぎかか|__なぎ__ なたしき __か__ ぎ __か__ っこ|
|『』|なぎにか|__なぎ__ なたしき __に__ じゅう __か__ ぎかっこ|
|【】|なぎすか|__なぎ__ なたしき __す__ みつき __か__ っこ|
|《》|なぎにや|__なぎ__ なたしき __に__ じゅう __や__ まかっこ|
|×　　　×　　　×|なぎばつ|__なぎ__ なたしき __ばつ__|
|○|なぎまる|__なぎ__ なたしき __まる__|
|｜|なぎたせ|__なぎ__ なたしき __た__ て __せ__ ん|

### Windows辞書式の場合
古いIMEでは使えないかもしれません。

また、可能であれば次の設定をすると、かな入力中でも JK+Q (文末へ) が効くようになります。
IMEのキー設定
|* キー|入力/変換済み文字なし|他|
|---|:---:|:---:|
|Ctrl+Shift+変換| - |全確定|
### Mac辞書式の場合
日本語IMのライブ変換は使用できません。  
M+Comma+Z を押して「　　　×　　　×　　　×」が入力できなければ、変換学習を一度リセットしてください。

また、「キーボード設定を開く...」から「入力ソース」に英語「U.S.」を加え、「英数」キーでIMをオフにしたとき「U.S.」になるようにすると、かな入力中でも JK+Q (文末へ) が効くようになります。
### Linux辞書式の場合
キーボード設定を日本語106キーボードにする。

Bluetooth接続の時、「選択範囲を括弧でくくる」編集モードを使ったあとにクリップボードは消去されません。
### iOS辞書式(BMP専用)の場合
iOSの日本語IMに備わっていないので「ひらがな変換」「カタカナ変換」「再変換」は使えません。
## OSの設定 (辞書を使わない場合)
### Windowsの場合
キーボード設定を日本語106キーボードにする。
[WinCompose](http://wincompose.info/)をインストールする。

IMEのキー設定
|* キー|入力/変換済み文字なし|他|
|---|:---:|:---:|
|Ctrl+Shift+無変換| - |全消去|
|Ctrl+Shift+変換| - |全確定|
### Macの場合
キーボードが日本語/英語どちらの設定でも動きます。
#### IM に「かわせみ」を使わない場合
「キーボード設定を開く...」から「入力ソース」に英語「U.S.」を加えます。
「英数」キーでIMをオフにしたとき「U.S.」になるようにしてください。

さらに、[Karabiner-Elements](https://karabiner-elements.pqrs.org/)をインストールします。
ファイル unicode_hex_input_switcher.json をフォルダ ~/.config/karabiner/assets/complex_modification/ にコピーし、
Karabiner-Elements に Unicode Hex Input Switcher を登録してください。

念のため、Karabiner-Elements の設定 Device で、本ファームウェアが入ったキーボードが有効になっているか確認してください。
#### IM に「かわせみ」を使用する場合
コード入力に Control+Option+Shift+かな を設定してください。
（config.h の中に ``#define NG_USE_KAWASEMI`` と ``#define UNICODE_KEY_MAC KC_NO`` を書き加えてコンパイルします）
### Linuxの場合
キーボードが日本語/英語どちらの設定でも動きます。

IMEのキー設定
|モード|入力キー|コマンド|備考|
|---|:---:|:---:|---|
|変換前入力中|Ctrl Shift Muhenkan|__キャンセル__|追加|
|変換中|〃|__〃__|追加|
|入力文字なし|Ctrl Space|__IME を 無効化__|追加|
|変換前入力中|〃|__〃__||
|変換中|〃|__〃__||
## QMKファームウェアの設定
独自拡張として、標準のシフト&スペースに加えて、シフト&エンターキーを追加しました。
NG_SHFT2をキーマップに配置すると、単押しならエンター、
同時押しで薙刀式のシフトキーとして機能します。

OLEDが有効な場合には左側のOLEDには、
日本語入力モードに応じて「かな」または「ABC」と表紙されます。
右側のOLEDには薙刀式のロゴが表示されます。薙刀式のロゴは大岡俊彦氏に帰属します。

3キー同時押しのカーソル移動と、Delキーにだけキーリピートが効きます。

F+G を押さなくても 左右シフト＋英字 で 固定英数入力かIMEオフになるので、アルファベットの入力がすぐにできます。  
再びかな入力にするときは H+J を押して IMEオン にします。
## キーボードの切り替え操作
以下の機能を動的に切り替えることができます。
設定内容をEEPROMに記録することができます。
| 設定項目 | 設定 | キーコード | 関数呼び出し |
|---|---|---|---|
| OS切り替え            | Windows  | NGSW_WIN  | switchOS(NG_WIN)  |
|                      | MacOS    | NGSW_MAC  | switchOS(NG_MAC)  |
|                      | Linux    | NGSW_LNX  | switchOS(NG_LNX)  |
|                      | iOS(BMP専用) | NGSW_IOS  | switchOS(NG_IOS)  |
| 縦書き、横書き        | ON/OFFトグル   | NG_TAYO    | tategaki_toggle()  |
| 後置シフト            | ON/OFFトグル   | NG_KOTI  | kouchi_shift_toggle()  |
| 現在設定の出力        |   | NG_SHOS   | ng_show_os()  |

本家のDvorakJ版薙刀式は前置シフトのみですが、
時間制限付き後置シフトも有効にできます。
naginata.h 内の `#define NG_KOUCHI_SHIFT_MS 60` にミリ秒単位で設定し、コンパイルします。

OLEDをオンにしているときは、設定の状態がOLEDに表示されます。
 * 1行目 OS設定。Windows、Mac、Linuxの頭文字です。
 * 2行目 縦書き(T)、横書き(Y)
 * 3行目 後置シフト(Kでオン)
## 不具合
* 定義が設定されていないキーを押しても、何の代わりも出力しない  
この場合、キーマップから該当するキーを NG_** でないものに変えてください。
* Windows 11以降のメモ帳では、表示が引っかかったり入力を正しく行えないことがあるため使えません。
* Windows の秀丸エディタでは、入力が速すぎると表示が乱れたりクラッシュすることがあります。
* 薙刀式オン(H+JまたはNG_ON)を押した後、シフトなどの装飾キーは一度離してください。
* (辞書式・新MS-IME) かな変換中に英数入力に切り替え、確定しないでキーを押すと最初の文字が入力されない。
* (辞書式・新MS-IME) かな変換中に Shift+英数 を押すと最初の文字が入力されない。
## DvorakJ版、Hachikuとの違い
DvorakJでは、押しているキーが少ないときにどれかキーを離すと残りが出力されますが、本方式とHachikuでは出力済みのキーを離してもなにもしません。
### 文字キーを押し、未出力のままスペースを押し離す
|DvorakJ|Hachiku|naginata_v15m|
|---|---|---|
|何も文字が出力されないままスペース押しが起きる|残った文字を出力しスペース押しが起きる|同左|
### かな2文字→どちらか離す
キー|DvorakJ|Hachiku|naginata_v15m|
|---|---|---|---|
|J押す||||
|I押す||||
|J離す|ある|あ|あ|
|I離す|ある|ある|ある|

キー|DvorakJ|Hachiku|naginata_v15m|
|---|---|---|---|
|J押す||||
|I押す||||
|I離す|ある|ある|ある|
|J離す|ある|ある|ある|

DvorakJ版はキーを離してすべて入力されることがあります。
Hachikuと本バージョンは、まだ同時押しになるキーがあったら待つようになっています。
### 2キー同時押し→キー1個離す→3キー同時押し
キー|DvorakJ|Hachiku|naginata_v15m|注|
|---|---|---|---|---|
|J押す|||||
|I押す|||||
|I離す|ある|ある|ある||
|I押す|ある|ある|ある|(1)|
|R押す|ある|ある|あるじょ|(2)|
|L押す|ある|あるしょ|あるじょ||
|J離す|ある|あるしょ|あるじょ|(3)|
|I離す|あるしょう|あるしょ|あるじょ||
|L離す|あるしょう|あるしょう|あるじょう||
|R離す|あるしょう|あるしょう|あるじょう||
|Z押す|あるしょう|あるしょう|あるじょう||
|L押す|あるしょう|あるしょうほ|あるじょうほ||
|Z離す|あるしょうほう|あるしょうほ|あるじょうほ||
|L離す|あるしょうほう|あるしょうほう|あるじょうほう||

DvorakJで 3かな以上のロールオーバー押しをしたときは、__最初に離すキーを選びます__。  
(3)で J以外のキーを最初に離せば、「あるじょ」と入力されます。
Hachikuでは __キーを離した後は、左にあるキーを先に押さないと__ 3キー同時押しになりません。  
(1)で Iより先に Rを押せば、(2)では「あるじょ」と入力されます。
### 4キー以上のキー押し→キー1個離す→キー押し
キー|DvorakJ|Hachiku|naginata_v15m|
|---|---|---|---|
|RJI押す||じょ|じょ|
|L押す||じょ|じょ|
|R離す|じょう|じょ|じょ|
|S押す|じょう|じょう|じょう|
|D押す|じょう|じょうげ|じょうげ|
|全部離す|じょうけと|じょうげと|じょうげと|
||(離す順序によって不定)|||

キー|DvorakJ|Hachiku|naginata_v15m|
|---|---|---|---|
|D押す||||
|S押す||と|と|
|K押す||と|と|
|F押す||とけ|とけ|
|K離す|とけいか|とけい|とけい|
|K押す|とけいか|とけい|とけい|
|全部離す|とけいかい|とけいかい|とけいかい|
||(離す順序によって不定)|||
## 変換ロジック
関数which_trans_state()を利用し、早期出力をします。

その仕組みです。  
戻り値がOneの時はそのまま検索、Noneの時は後ろを縮めて検索、Multipulの時は候補を絞れないので次の入力を待ちます。  
未変換のキーが3つあれば即変換してよいので関数は使用しません。

キー|キー残り|出力|関数戻り値|補足|
|---|---|---|:---:|---|
|あ押す|(あ)||Multipul||
|い押す|(あい)||Multipul||
|ら押す|(あいら)||-|3キーなので変換。定義を探すがないので縮める|
||(あい)ら||-|定義を探すがないので縮める|
||(あ)いら|あ|-||
||(いら)||None|__残りを評価し__、Noneなので後ろを縮める|
||(い)ら|い|-||
||(ら)||Multipul|__残りを評価し__、終わり|

1つかなを出力したら残りをまた関数にかけるのがポイントです。

キーを離した後の入力で、濁点や拗音を再利用するのはDvorakJを真似ていますが、今押したキー以外が出力済みになる時だけにしています。

上の方「__じょうげと__」の例では、「じょう」を押したあとにRを離しSを押しています。この時点で「じょう」まで出力されるので、「け(S)」は「濁点(J)」を再利用します。

「__とけいかい__」の例では、「とけいか」を押して「い(K)」を離し、再び押しています。この時の出力は「とけい」までで、「か」がまだなのでDF+Kの編集モードにはなりません。
